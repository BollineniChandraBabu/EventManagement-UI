<div class="page">
  <!-- Hero -->
  <div class="account-hero">
    <div class="account-hero-content">
      <div class="account-avatar">
        <i class="fa-solid fa-user-secret" *ngIf="impersonation.isImpersonating()"></i>
        <i class="fa-solid fa-user" *ngIf="!impersonation.isImpersonating()"></i>
      </div>
      <div>
        <h1 class="page-header-title">
          <ng-container *ngIf="impersonation.isImpersonating()">
            Viewing as {{ impersonation.impersonatedUser()?.name }}
          </ng-container>
          <ng-container *ngIf="!impersonation.isImpersonating()">My Account</ng-container>
        </h1>
        <p class="page-header-subtitle">
          <ng-container *ngIf="impersonation.isImpersonating()">
            <span class="impersonation-badge">
              <i class="fa-solid fa-user-secret me-1"></i>Impersonation mode â€” your admin token is still active
            </span>
          </ng-container>
          <ng-container *ngIf="!impersonation.isImpersonating()">
            Manage your profile, notification preferences, and security settings
          </ng-container>
        </p>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left: Profile + Wish Settings -->
    <div class="col-12 col-xl-7">
      <!-- Profile Card -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="section-title mb-4">
            <i class="fa-solid fa-id-badge me-2" style="color:var(--c-primary);"></i>Profile Details
          </h2>
          <div class="alert-info rounded p-3 mb-4 d-flex align-items-center gap-2" style="font-size:.875rem;">
            <i class="fa-solid fa-circle-info"></i>
            Profile editing is managed by your administrator.
          </div>

          <div class="pollinations-balance-card mb-4" *ngIf="isAdmin()">
            <div class="d-flex align-items-center justify-content-between gap-3">
              <div>
                <div class="pollinations-balance-label">Pollinations API Balance</div>
                <div class="pollinations-balance-value" *ngIf="!isBalanceLoading; else loadingBalance">
                  {{ pollinationsBalance ?? 0 }}
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" (click)="loadPollinationsBalance()" [disabled]="isBalanceLoading">
                <i class="fa-solid" [class.fa-rotate-right]="!isBalanceLoading" [class.fa-spinner]="isBalanceLoading" [class.fa-spin]="isBalanceLoading"></i>
              </button>
            </div>
            <ng-template #loadingBalance>
              <div class="pollinations-balance-value text-muted">Loadingâ€¦</div>
            </ng-template>
          </div>
          <form [formGroup]="profileForm" class="row g-3" novalidate>
            <div class="col-12">
              <label class="form-label">Full name</label>
              <input class="form-control" type="text" formControlName="fullName" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Email address</label>
              <input class="form-control" type="email" formControlName="email" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Role</label>
              <input class="form-control" [value]="profileForm.controls.role.value" readonly />
            </div>
          </form>
        </div>
      </div>

      <!-- Wish Settings Card -->
      <div class="card">
        <div class="card-body">
          <h2 class="section-title mb-4">
            <i class="fa-solid fa-wand-sparkles me-2" style="color:#d97706;"></i>Wish Preferences
          </h2>
          <form [formGroup]="wishSettingsForm" class="wish-settings" novalidate>
            <div class="wish-toggle-card" [class.wish-toggle-card--on]="wishSettingsForm.controls.isBirthdayEnabled.value">
              <span class="wish-emoji">ðŸŽ‚</span>
              <div class="wish-info">
                <div class="wish-title">Birthday Wishes</div>
                <div class="wish-sub">Automated birthday greetings</div>
              </div>
              <div class="form-check form-switch ms-auto mb-0">
                <input class="form-check-input" type="checkbox" id="isBirthdayEnabled" formControlName="isBirthdayEnabled" />
              </div>
            </div>

            <div class="wish-toggle-card" [class.wish-toggle-card--on]="wishSettingsForm.controls.isGoodMorningEnabled.value">
              <span class="wish-emoji">ðŸŒ…</span>
              <div class="wish-info">
                <div class="wish-title">Good Morning</div>
                <div class="wish-sub">Daily morning greetings</div>
              </div>
              <div class="form-check form-switch ms-auto mb-0">
                <input class="form-check-input" type="checkbox" id="isGoodMorningEnabled" formControlName="isGoodMorningEnabled" />
              </div>
            </div>

            <div class="wish-toggle-card" [class.wish-toggle-card--on]="wishSettingsForm.controls.isGoodNightEnabled.value">
              <span class="wish-emoji">ðŸŒ™</span>
              <div class="wish-info">
                <div class="wish-title">Good Night</div>
                <div class="wish-sub">Evening goodnight messages</div>
              </div>
              <div class="form-check form-switch ms-auto mb-0">
                <input class="form-check-input" type="checkbox" id="isGoodNightEnabled" formControlName="isGoodNightEnabled" />
              </div>
            </div>

            <div class="d-flex justify-content-end pt-2">
              <button type="button" class="btn btn-primary" (click)="saveWishSettings()">
                <i class="fa-solid fa-floppy-disk me-2"></i>Save preferences
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right: Password + Session -->
    <div class="col-12 col-xl-5">
      <!-- Change Password (hidden while impersonating) -->
      <div class="card mb-4" *ngIf="!impersonation.isImpersonating()">
        <div class="card-body">
          <h2 class="section-title mb-4">
            <i class="fa-solid fa-lock me-2" style="color:#7c3aed;"></i>Change Password
          </h2>
          <form [formGroup]="changePasswordForm" class="row g-3" (ngSubmit)="submitPasswordChange()" novalidate>
            <div class="col-12">
              <label class="form-label">Current password</label>
              <div class="input-group">
                <input class="form-control" [type]="showCurrentPassword ? 'text' : 'password'" formControlName="currentPassword" />
                <button class="btn btn-outline-secondary" type="button" (click)="togglePasswordVisibility('current')">
                  <i class="fa-regular" [class.fa-eye]="!showCurrentPassword" [class.fa-eye-slash]="showCurrentPassword"></i>
                </button>
              </div>
              <small class="text-danger mt-1 d-block" *ngIf="changePasswordForm.controls.currentPassword.touched && changePasswordForm.controls.currentPassword.invalid">
                Current password is required.
              </small>
            </div>

            <div class="col-12">
              <label class="form-label">New password</label>
              <div class="input-group">
                <input class="form-control" [type]="showNewPassword ? 'text' : 'password'" formControlName="newPassword" />
                <button class="btn btn-outline-secondary" type="button" (click)="togglePasswordVisibility('new')">
                  <i class="fa-regular" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
                </button>
              </div>
              <small class="text-danger mt-1 d-block" *ngIf="changePasswordForm.controls.newPassword.touched && changePasswordForm.controls.newPassword.invalid">
                At least 8 characters required.
              </small>
            </div>

            <div class="col-12">
              <label class="form-label">Confirm new password</label>
              <div class="input-group">
                <input class="form-control" [type]="showConfirmPassword ? 'text' : 'password'" formControlName="confirmPassword" />
                <button class="btn btn-outline-secondary" type="button" (click)="togglePasswordVisibility('confirm')">
                  <i class="fa-regular" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
                </button>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-end">
              <button type="submit" class="btn btn-outline-primary" [disabled]="isChangingPassword">
                <i class="fa-solid me-1" [class.fa-key]="!isChangingPassword" [class.fa-spinner]="isChangingPassword" [class.fa-spin]="isChangingPassword"></i>
                {{ isChangingPassword ? 'Changingâ€¦' : 'Change password' }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Return to Admin card (shown only while impersonating) -->
      <div class="card mb-4 return-admin-card" *ngIf="impersonation.isImpersonating()">
        <div class="card-body">
          <h2 class="section-title mb-2" style="color:#d97706;">
            <i class="fa-solid fa-user-secret me-2"></i>Impersonation Active
          </h2>
          <p class="text-muted mb-4" style="font-size:.875rem;">
            You are currently viewing the application as
            <strong>{{ impersonation.impersonatedUser()?.name }}</strong>.
            Password changes and sign-out are disabled in this mode.
          </p>
          <button type="button" class="btn btn-warning" (click)="returnToAdmin()">
            <i class="fa-solid fa-rotate-left me-2"></i>Return to Admin Account
          </button>
        </div>
      </div>

      <!-- Session Card â€” sign out only when NOT impersonating -->
      <div class="card session-card" *ngIf="!impersonation.isImpersonating()">
        <div class="card-body">
          <h2 class="section-title mb-2">
            <i class="fa-solid fa-right-from-bracket me-2" style="color:var(--c-error);"></i>Session
          </h2>
          <p class="text-muted mb-4" style="font-size:.875rem;">Always sign out on shared or public devices to protect your account.</p>
          <button type="button" class="btn btn-outline-danger" (click)="logout()">
            <i class="fa-solid fa-right-from-bracket me-2"></i>Sign out
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
