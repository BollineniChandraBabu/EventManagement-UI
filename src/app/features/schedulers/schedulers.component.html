<div class="page">
  <div class="card border-0 shadow-3 rounded-5 users-card">
    <div class="card-body p-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <h2 class="h4 mb-0">Schedulers</h2>
        <div class="d-flex align-items-center gap-2">
          <span class="badge rounded-pill badge-primary">{{ totalElements }} total jobs</span>
          <button class="btn btn-sm btn-outline-primary" type="button" (click)="refresh()" [disabled]="loading">Refresh</button>
        </div>
      </div>

      <div *ngIf="message" class="alert alert-info py-2">{{ message }}</div>

      <div class="row g-3 align-items-end mb-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Filter schedulers</label>
          <input class="form-control" type="text" placeholder="Search by name/type/status"
                 [ngModel]="filterText" (ngModelChange)="onSearch($event)" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Rows per page</label>
          <select class="form-select" (change)="onPageSizeChange($any($event.target).value)">
            <option *ngFor="let size of pageSizes" [value]="size" [selected]="size === pageSize">{{ size }}</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>State</th>
            <th>Runs (T/S/F)</th>
            <th>Success %</th>
            <th>Last Status</th>
            <th>Last Started</th>
            <th>Last Completed</th>
            <th>Next Fire</th>
            <th>Previous Fire</th>
            <th>Last Duration</th>
            <th class="text-end">Action</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let scheduler of viewSchedulers; trackBy: trackByScheduler">
            <td class="fw-semibold">{{ scheduler.name }}</td>
            <td>{{ scheduler.type }}</td>
            <td>
              <span class="badge rounded-pill" [class.bg-success]="scheduler.running" [class.bg-secondary]="!scheduler.running">
                {{ scheduler.running ? 'Running' : 'Idle' }}
              </span>
            </td>
            <td>{{ scheduler.totalRuns }} / {{ scheduler.successRuns }} / {{ scheduler.failedRuns }}</td>
            <td>{{ successRate(scheduler) }}%</td>
            <td>
              <div>{{ scheduler.lastStatus || '-' }}</div>
              <small class="text-danger" *ngIf="scheduler.lastError">{{ scheduler.lastError }}</small>
            </td>
            <td>{{ scheduler.lastStartedAt ? (scheduler.lastStartedAt | date:'medium') : '-' }}</td>
            <td>{{ scheduler.lastCompletedAt ? (scheduler.lastCompletedAt | date:'medium') : '-' }}</td>
            <td>{{ scheduler.nextFireTime ? (scheduler.nextFireTime | date:'medium') : '-' }}</td>
            <td>{{ scheduler.previousFireTime ? (scheduler.previousFireTime | date:'medium') : '-' }}</td>
            <td>{{ scheduler.lastDurationMs != null ? (scheduler.lastDurationMs + ' ms') : '-' }}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-success" type="button" (click)="trigger(scheduler)" [disabled]="isTriggering(scheduler.name)">
                {{ isTriggering(scheduler.name) ? 'Triggering...' : 'Run now' }}
              </button>
            </td>
          </tr>
          <tr *ngIf="!loading && viewSchedulers.length === 0">
            <td colspan="12" class="text-center text-muted py-4">No schedulers found.</td>
          </tr>
          <tr *ngIf="loading">
            <td colspan="12" class="text-center text-muted py-4">Loading schedulers...</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <small class="text-muted">Showing {{ startRow }}-{{ endRow }} of {{ totalElements }} jobs</small>
        <div class="btn-group pagination-controls">
          <button class="btn btn-sm btn-outline-primary" type="button" (click)="prevPage()" [disabled]="page === 0">Previous</button>
          <button class="btn btn-sm btn-primary" type="button" disabled>Page {{ displayPage }} / {{ totalPages || 1 }}</button>
          <button class="btn btn-sm btn-outline-primary" type="button" (click)="nextPage()" [disabled]="page >= totalPages - 1">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
